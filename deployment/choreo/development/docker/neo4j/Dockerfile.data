# Fixed Neo4j Dockerfile with correct password handling order
# Key change: password reset happens *after* database restore

FROM ubuntu:22.04

RUN apt-get update && apt-get install -y \
    wget gnupg2 curl apt-transport-https openjdk-17-jdk \
    && rm -rf /var/lib/apt/lists/*

RUN wget -O - https://debian.neo4j.com/neotechnology.gpg.key | apt-key add - \
    && echo "deb https://debian.neo4j.com stable 5" > /etc/apt/sources.list.d/neo4j.list

RUN apt-get update && apt-get install -y neo4j=1:5.12.0 \
    wget unzip curl \
    && rm -rf /var/lib/apt/lists/*

RUN groupadd -g 10014 choreo && \
    useradd -u 10014 -g choreo -s /bin/bash -m choreouser && \
    mkdir -p /home/choreouser/.cache && \
    chown -R choreouser:choreo /home/choreouser && \
    chmod -R 755 /home/choreouser

ENV NEO4J_AUTH=neo4j/neo4j123 \
    NEO4J_server_memory_pagecache_size=1G \
    NEO4J_server_memory_heap_initial__size=1G \
    NEO4J_server_memory_heap_max__size=1G \
    NEO4J_server_security_procedures_unrestricted=gds.*,apoc.* \
    NEO4J_server_directories_data=/neo4j_data \
    NEO4J_server_directories_logs=/neo4j_logs \
    NEO4J_server_directories_import=/var/lib/neo4j/import \
    NEO4J_server_directories_plugins=/neo4j_plugins \
    NEO4J_server_default__listen__address=0.0.0.0 \
    NEO4J_server_bolt_listen__address=0.0.0.0:7687 \
    NEO4J_server_http_listen__address=0.0.0.0:7474

RUN mkdir -p /neo4j_data /neo4j_logs /neo4j_plugins /var/log/neo4j /var/lib/neo4j/data /var/lib/neo4j/run \
    && chown -R 10014:10014 /neo4j_data /neo4j_logs /neo4j_plugins /var/log/neo4j /var/lib/neo4j /var/lib/neo4j/run \
    && chmod -R 755 /neo4j_data /neo4j_logs /neo4j_plugins /var/log/neo4j /var/lib/neo4j /var/lib/neo4j/run

RUN echo "server.default_listen_address=0.0.0.0" >> /etc/neo4j/neo4j.conf \
    && echo "server.bolt.listen_address=0.0.0.0:7687" >> /etc/neo4j/neo4j.conf \
    && echo "server.http.listen_address=0.0.0.0:7474" >> /etc/neo4j/neo4j.conf

# --- Load Data Backup ---
RUN echo "Restoring Neo4j data from GitHub backup..." && \
    GITHUB_REPO="LDFLK/data-backups" && \
    BACKUP_VERSION="0.0.1" && \
    ENVIRONMENT="development" && \
    temp_dir=$(mktemp -d) && \
    archive_url="https://github.com/$GITHUB_REPO/archive/refs/tags/$BACKUP_VERSION.zip" && \
    archive_file="$temp_dir/archive.zip" && \
    wget -q "$archive_url" -O "$archive_file" && \
    unzip -q "$archive_file" -d "$temp_dir" && \
    archive_dir="$temp_dir/data-backups-$BACKUP_VERSION" && \
    backup_dir="$archive_dir/nexoan/version/$BACKUP_VERSION/$ENVIRONMENT/neo4j" && \
    if [ -f "$backup_dir/neo4j.dump" ]; then \
        mkdir -p /neo4j_data/databases && \
        neo4j-admin database load neo4j --from-path="$backup_dir" --overwrite-destination=true; \
    else \
        echo "WARNING: Backup file not found, empty DB will be used"; \
    fi && \
    rm -rf "$temp_dir"

# --- Reset Password AFTER data load ---
RUN password="${NEO4J_AUTH#neo4j/}" && \
    neo4j-admin dbms set-initial-password "$password" || true

# Entrypoint
RUN echo '#!/bin/bash\nset -e\nexec neo4j console' > /docker-entrypoint.sh && chmod +x /docker-entrypoint.sh

USER 10014

EXPOSE 7474 7687

VOLUME ["/neo4j_data", "/neo4j_logs", "/var/lib/neo4j/import", "/neo4j_plugins"]

HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 CMD curl -f http://localhost:7474 || exit 1

CMD ["/docker-entrypoint.sh"]
